<div class="container py-5">
  <h1 class="h3 mb-4">Tu carrito</h1>

  <div id="empty" class="alert alert-info d-none">
    Tu carrito está vacío. <a href="/libros">Ir al catálogo</a>
  </div>

  <div id="cart" class="card shadow-sm d-none">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Libro</th>
            <th style="width:120px;">Precio</th>
            <th style="width:140px;">Cantidad</th>
            <th style="width:140px;">Subtotal</th>
            <th style="width:60px;"></th>
          </tr>
        </thead>
        <tbody id="cart-body"></tbody>
      </table>
    </div>

    <div class="p-3 d-flex justify-content-end gap-3 border-top">
      <div class="me-auto">
        <label class="form-label mb-1">Dirección de envío</label>
        <input id="direccion" class="form-control" placeholder="Tu dirección completa" required>
        <div class="mt-2">
          <label class="form-label mb-1">Teléfono (opcional)</label>
          <input id="telefono" class="form-control" placeholder="+593 ...">
        </div>
      </div>
      <div class="text-end">
        <div class="fs-5 mb-2">Total: <strong id="total">$0.00</strong></div>
        <button id="btn-checkout" class="btn btn-success">
          <i class="bi bi-bag-check"></i> Finalizar compra
        </button>
      </div>
    </div>
  </div>

  <div id="msg" class="alert d-none mt-3" role="alert"></div>
</div>

<script>
  const BACKEND_URL = '{{backendUrl}}';

  function loadCart() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const tbody = document.getElementById('cart-body');
    const empty = document.getElementById('empty');
    const card = document.getElementById('cart');
    const totalEl = document.getElementById('total');

    tbody.innerHTML = '';

    if (!carrito.length) {
      empty.classList.remove('d-none');
      card.classList.add('d-none');
      totalEl.textContent = '$0.00';
      return;
    }

    empty.classList.add('d-none');
    card.classList.remove('d-none');

    let total = 0;
    carrito.forEach((item, idx) => {
      const precio = Number(item.precio);
      const cant = Number(item.cantidad);
      const sub = precio * cant;
      total += sub;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.titulo}</td>
        <td>$${precio.toFixed(2)}</td>
        <td>
          <div class="input-group input-group-sm">
            <button class="btn btn-outline-secondary" data-idx="${idx}" data-op="-">-</button>
            <input class="form-control text-center" style="max-width:60px;" value="${cant}" readonly>
            <button class="btn btn-outline-secondary" data-idx="${idx}" data-op="+">+</button>
          </div>
        </td>
        <td>$${sub.toFixed(2)}</td>
        <td><button class="btn btn-link text-danger p-0" data-idx="${idx}" data-op="x"><i class="bi bi-trash"></i></button></td>
      `;
      tbody.appendChild(tr);
    });

    totalEl.textContent = '$' + total.toFixed(2);
  }

  // Cambios de cantidad / eliminar
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const op = btn.dataset.op;
    const idx = btn.dataset.idx;
    if (!op) return;

    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    if (!carrito[idx]) return;

    if (op === '+') carrito[idx].cantidad++;
    if (op === '-' && carrito[idx].cantidad > 1) carrito[idx].cantidad--;
    if (op === 'x') carrito.splice(idx, 1);

    localStorage.setItem('carrito', JSON.stringify(carrito));
    loadCart();
    updateCartCounter();
  });

  // Checkout
  document.getElementById('btn-checkout')?.addEventListener('click', async () => {
    const token = localStorage.getItem('token');
    const direccion = document.getElementById('direccion').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const msg = document.getElementById('msg');

    if (!token) {
      sessionStorage.setItem('backTo', '/carrito');
      window.location.href = '/login';
      return;
    }
    if (!direccion) {
      msg.className = 'alert alert-warning';
      msg.textContent = 'Por favor ingresa tu dirección de envío.';
      return;
    }

    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    if (!carrito.length) return;

    const items = carrito.map(i => ({ libro_id: Number(i.id), cantidad: Number(i.cantidad) }));

    try {
      const resp = await fetch(`${BACKEND_URL}/pedidos`, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ items, direccion_envio: direccion, telefono_contacto: telefono })
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Error al procesar el pedido');

      localStorage.removeItem('carrito');
      loadCart();
      updateCartCounter();
      msg.className = 'alert alert-success';
      msg.innerHTML = '¡Pedido realizado con éxito! <a href="/">Volver al inicio</a>';
    } catch (err) {
      msg.className = 'alert alert-danger';
      msg.textContent = err.message;
    }
  });

  // Contador global del carrito en el navbar
  function updateCartCounter() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const totalItems = carrito.reduce((s, it) => s + Number(it.cantidad), 0);
    document.querySelectorAll('.cart-counter').forEach(el => {
      el.textContent = totalItems;
      el.style.display = totalItems > 0 ? 'inline' : 'none';
    });
  }

  // Inicializar
  loadCart();
  updateCartCounter();
</script>
